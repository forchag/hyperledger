<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Connect Sensors</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <header class="bg-dark text-white text-center py-3 mb-4">
    <h1>AgriCrypt-Chain Farm Dashboard</h1>
  </header>
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/integrity">Data Integrity</a></li>
        <li class="nav-item"><a class="nav-link" href="/connect">Sensor Connection</a></li>
        <li class="nav-item"><a class="nav-link" href="/simulate-ui">Sensor Simulator</a></li>
        <li class="nav-item"><a class="nav-link" href="/status">Network Status</a></li>
        <li class="nav-item"><a class="nav-link" href="/tde">Threat Detection</a></li>
        <li class="nav-item"><a class="nav-link" href="/history">Sensor History</a></li>
        <li class="nav-item"><a class="nav-link" href="/explorer">Blockchain Explorer</a></li>
        <li class="nav-item"><a class="nav-link" href="/devices">Device Management</a></li>
        <li class="nav-item"><a class="nav-link" href="/storage">Storage Monitor</a></li>
        <li class="nav-item"><a class="nav-link" href="/recovery">Recovery</a></li>
        <li class="nav-item"><a class="nav-link" href="/access-log">Access Log</a></li>
      </ul>
    </div>
  </nav>
  <div class="container py-4">
  <h1 class="mb-3">Connect Sensors to Your Node</h1>
  <div class="mb-3">
    <label class="form-label">Select Node
      <select id="node-select" class="form-select"></select>
    </label>
  </div>
  <p class="mb-4">This page explains how to attach common sensors to a Raspberry Pi-based node. Select the GPIO pin used for each sensor and note the metric each sensor provides.</p>

  <div id="saveMsg" class="alert alert-success d-none" role="alert"></div>

  <form id="sensor-form" class="row g-3">
    <div class="col-md-6">
      <div class="card sensor-section">
        <div class="card-header">DHT22 (Temperature &amp; Humidity)</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">GPIO Pin
              <select name="dht22_pin" class="form-select">
                <option value="4">4</option>
                <option value="17">17</option>
                <option value="27">27</option>
                <option value="22">22</option>
              </select>
            </label>
          </div>
          <p class="mb-0">Measures: <strong>temperature</strong> (&deg;C) and <strong>humidity</strong> (%)</p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card sensor-section">
        <div class="card-header">Soil Moisture Sensor</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">GPIO Pin
              <select name="soil_pin" class="form-select">
                <option value="17">17</option>
                <option value="27">27</option>
                <option value="22">22</option>
                <option value="5">5</option>
              </select>
            </label>
          </div>
          <p class="mb-0">Measures: <strong>soil moisture</strong> (%)</p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card sensor-section">
        <div class="card-header">pH Sensor</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">GPIO Pin
              <select name="ph_pin" class="form-select">
                <option value="18">18</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
              </select>
            </label>
          </div>
          <p class="mb-0">Measures: <strong>soil pH</strong></p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card sensor-section">
        <div class="card-header">Light Sensor</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">GPIO Pin
              <select name="light_pin" class="form-select">
                <option value="6">6</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="19">19</option>
              </select>
            </label>
          </div>
          <p class="mb-0">Measures: <strong>light level</strong></p>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card sensor-section">
        <div class="card-header">Water Level Sensor</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">GPIO Pin
              <select name="water_pin" class="form-select">
                <option value="16">16</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="26">26</option>
              </select>
            </label>
          </div>
          <p class="mb-0">Measures: <strong>water level</strong> (%)</p>
        </div>
      </div>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">Save Configuration</button>
      <button id="check-btn" type="button" class="btn btn-secondary ms-2">Check Connection</button>
      <span id="check-result" class="ms-3"></span>
    </div>
  </form>

  <p class="mt-4">The information entered here can be used by a setup script to configure sensor mappings for each node.</p>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadNodes(){
      const res = await fetch('/discover');
      const data = await res.json();
      const select = document.getElementById('node-select');
      select.innerHTML = data.nodes.map(n => `<option value="${n.ip}">${n.ip}</option>`).join('');
    }

    document.getElementById('sensor-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const msg = document.getElementById('saveMsg');
      msg.textContent = 'Configuration saved!';
      msg.classList.remove('d-none');
      setTimeout(() => msg.classList.add('d-none'), 3000);
    });

    document.getElementById('check-btn').addEventListener('click', async () => {
      const pins = {
        dht22: document.querySelector('[name="dht22_pin"]').value,
        soil: document.querySelector('[name="soil_pin"]').value,
        ph: document.querySelector('[name="ph_pin"]').value,
        light: document.querySelector('[name="light_pin"]').value,
        water: document.querySelector('[name="water_pin"]').value
      };
      const node = document.getElementById('node-select').value;
      const res = await fetch('/check-pins', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({node, pins})
      });
      const data = await res.json();
      document.getElementById('check-result').textContent = data.message;
    });

    window.onload = loadNodes;
  </script>
</body>
</html>
